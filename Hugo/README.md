## Hugo server

Заходим

```
ssh user@192.168.1.110
```

Переходим

```
cd homlab-blog
```

Запускаем сервер

```
hugo server
```

В результате на  http://192.168.1.110/ и видим сайт вместо 502 Bad Gateway

---

Закрываем терминал

Заходим на  http://192.168.1.110/ и снова видим 502 Bad Gateway

Переходим

```
sudo nano /etc/systemd/system/hugo-blog.service
```

Вставляем

```
[Unit]
Description=Hugo Blog Service
After=network.target

[Service]
Type=simple
User=user
WorkingDirectory=/home/user/homlab-blog
ExecStart=/usr/bin/hugo server --bind 127.0.0.1 --port 1313
Restart=always

[Install]
WantedBy=multi-user.target
```

```
sudo systemctl daemon-reload
sudo systemctl restart hugo-blog
```

Снова заходим на http://192.168.1.110/ и видим снова сайт вместо 502 Bad Gateway

---

#### Объяснение изложенного выше:

Для того чтобы сайт продолжал работать после закрытия терминала, вам нужно запустить Hugo как фоновый процесс (демон).

Вот 3 способа, от самого быстрого до самого правильного:

1. Самый быстрый (использование `nohup`)

Эта команда игнорирует сигнал закрытия терминала и перенаправляет вывод в файл.

bash

```
nohup hugo server --bind 0.0.0.0 --port 1313 > hugo.log 2>&1 &
```

- `--bind 0.0.0.0` — позволит открывать сайт по IP малинки (если нужно).
- `> hugo.log 2>&1` — сохранит все логи в файл `hugo.log`.
- `&` — отправит процесс в фоновый режим.

**Как остановить:** `pkill hugo`

------

2. Через терминальный мультиплексор `screen` (удобно для отладки)

Это создает виртуальное окно терминала, которое не закрывается.

1. Запустите сессию: `screen -S blog`
2. Внутри запустите `hugo server`.
3. Нажмите сочетание клавиш **Ctrl + A**, затем **D** (отсоединиться).
4. Теперь можно закрывать терминал. Сайт будет работать.

**Как вернуться к процессу:** `screen -r blog`

------

3. Правильный способ (Systemd сервис) — **Рекомендуется**

Это заставит сайт запускаться автоматически даже после перезагрузки Raspberry Pi.

1. Создайте файл сервиса:

   bash

   ```
   sudo nano /etc/systemd/system/hugo-blog.service
   ```

   

2. Вставьте туда следующий текст (замените `user` на ваше имя пользователя):

   ini

   ```
   [Unit]
   Description=Hugo Blog Service
   After=network.target
   
   [Service]
   Type=simple
   User=user
   WorkingDirectory=/home/user/homlab-blog
   ExecStart=/usr/bin/hugo server --bind 127.0.0.1 --port 1313
   Restart=always
   
   [Install]
   WantedBy=multi-user.target
   ```

   *(Примечание: если используете порт 80, Hugo нужно запускать от root или разрешить использование портов ниже 1024).*

3. Запустите сервис:

   bash

   ```
   sudo systemctl daemon-reload
   sudo systemctl enable hugo-blog
   sudo systemctl start hugo-blog
   ```

   .

------

Важное замечание по портам:

В предыдущем вопросе вы пробрасывали порт `8080:localhost:80`.
Если ваш Hugo запущен на порту **1313** (как в логе), то команда для SSH-туннеля должна быть:

bash

```
ssh -f -N -R 8080:localhost:1313 root@103.71.20.34
```


Либо измените порт запуска Hugo на 80-й, если планируете использовать `8080:localhost:80`.

---

---



Чтобы SSH-туннель продолжал работать после закрытия терминала, используйте комбинацию флагов `-f` (фоновый режим) и `-N` (не выполнять команды).

Самый простой способ

Запустите команду в таком виде:

bash

```
ssh -f -N -R 8080:localhost:80 root@103.71.20.34
```



**Разбор флагов:**

- `-f`: Переводит SSH в фоновый режим сразу после ввода пароля.
- `-N`: Указывает не выполнять удаленные команды (нужно только для проброса портов).
- `-R`: Ваш проброс порта.

------

Рекомендуемый способ (авторестарт через `autossh`)

Обычный SSH-туннель разорвется при любой сетевой заминке. Чтобы туннель «поднимался» сам, используйте `autossh`.

1. **Установите его:**

   bash

   ```
   sudo apt update && sudo apt install autossh
   ```

   

2. **Запустите:**

   bash

   ```
   autossh -f -N -M 0 -R 8080:localhost:80 root@103.71.20.34
   ```

   

   *`-M 0` отключает собственный мониторинг autossh, полагаясь на стандартные настройки SSH.*

   

------

Важные советы:

1. **SSH-ключи:** Чтобы команда работала в фоне без запроса пароля (и автоматически запускалась после перезагрузки), настройте вход по ключу:

   bash

   ```
   ssh-copy-id root@103.71.20.34
   ```

   

2. **GatewayPorts:** Чтобы порт `8080` на удаленном сервере (103.71.20.34) был доступен из интернета, а не только локально внутри того сервера, в файле `/etc/ssh/sshd_config` на **удаленном** сервере должна быть строка:

   text

   ```
   GatewayPorts yes
   ```

   (После изменения файла нужно сделать `sudo systemctl restart ssh`).

3. **Как убить процесс:** Если нужно будет закрыть туннель, найдите его ID:

   bash

   ```
   pgrep -f "ssh -f -N -R 8080"
   kill [ID_процесса]
   ```

   

   

   
